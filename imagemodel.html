<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Car Brand & Model Detector</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<style>
  body { font-family: Arial; background:#111; color:#eee; text-align:center; margin:0; padding:20px; }
  h1 { margin-bottom:20px; }
  input { margin:20px; }
  #preview { max-width:300px; margin:20px auto; border-radius:8px; display:block; }
  #results { font-size:18px; margin-top:20px; white-space: pre-line; }
</style>
</head>
<body>

<h1>Car Brand & Model Detector</h1>
<input type="file" accept="image/*" onchange="loadImage(event)">
<img id="preview">
<div id="results">Loading model...</div>

<script>
let model, labels;

// Load model and labels
async function loadEverything() {
  try {
    // Load the TensorFlow.js model from relative path
    model = await tf.loadLayersModel("web_model/model.json");

    // Load labels
    const res = await fetch("labels.json");
    labels = await res.json();

    document.getElementById("results").innerText = "Model loaded. Upload a car image!";
  } catch (err) {
    console.error("Error loading model or labels:", err);
    document.getElementById("results").innerText = "Failed to load model. Check paths or file sizes.";
  }
}
loadEverything();

// Handle image upload
function loadImage(event) {
  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(event.target.files[0]);
  img.onload = () => predict(img);
}

// Predict car class
async function predict(img) {
  if (!model || !labels) return;

  let tensor = tf.browser.fromPixels(img)
    .resizeBilinear([224,224])
    .toFloat()
    .div(tf.scalar(255.0))
    .expandDims();

  const predictions = await model.predict(tensor).data();

  // Get top-3 predictions
  const topIndices = Array.from(predictions)
                          .map((p,i) => [p,i])
                          .sort((a,b) => b[0]-a[0])
                          .slice(0,3);

  let resultText = "Top Predictions:\n";
  topIndices.forEach(([prob, idx]) => {
    resultText += `${labels[idx]}: ${(prob*100).toFixed(2)}%\n`;
  });

  document.getElementById("results").innerText = resultText;
}
</script>

</body>
</html>
